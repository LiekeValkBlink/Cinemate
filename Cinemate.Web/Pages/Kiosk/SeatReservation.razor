@layout UserLayout
@page "/kiosk/seat-reservation"
@page "/kiosk/seat-reservation/{screeningId:int}"
@using Cinemate.Web.Services.Contracts
@using Cinemate.Models.Dto
@using Cinemate.Web.Services

<div class="cinema-overview">
    <div class="movie-screen"></div>
    <p>Filmscherm</p>

    @foreach (var row in _allSeats.GroupBy(s => s.Row))
    {
        <div class="seat-row">
            @foreach (var seat in row)
            {
                <div class="seat" style="background-color: @GetSeatBackgroundColor(seat.Id)"
                    @onclick="() => SelectSeat(seat.Id)">
                    @seat.Number
                </div>
            }
        </div>
    }
    
</div>

<div class="legenda-container">
    <div class="seat" style="background-color: green;"></div><p>Vrij</p>
    <div class="seat" style="background-color: yellow;"></div><p>Gekozen</p>
    <div class="seat" style="background-color: red;"></div><p>Bezet</p>
</div>

<div class="page-navigation">
    <button class="secondary-btn" @onclick="NavigateBack">
        <i class="fa-solid fa-chevron-left"></i>
        Terug
    </button>

    <button class="primary-btn" @onclick="OnProceed">
        Bevestig je keuze
        <i class="fa-solid fa-chevron-right"></i>
    </button>
</div>

@code {
    
    [Parameter] public int screeningId { get; set; }
    [Inject] NavigationManager NavigationManager { get; set; }
    [Inject] ISeatsService _seatsService { get; set; }
    [Inject] ITheaterRoomService _theaterRoomService { get; set; }
    [Inject] IScreeningService _screeningService { get; set; }
    private ScreeningWithInfoDto _screening;
    private IEnumerable<SeatsWInfoDto> _allSeats;
    private IEnumerable<ReservedSeatDto> _reservedSeat;
    private List<int> selectedSeats = new List<int>();
    
    protected override async Task OnInitializedAsync()
    {
        _screening = await _screeningService.GetScreening(screeningId);
        _allSeats = await _seatsService.GetSeatsByTheaterRoomId(_screening.TheaterRoomId);
        _reservedSeat = await _seatsService.GetReservedSeatsByScreeningId(_screening.Id);
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo($"/kiosk/show-reservation");
    }

    private void OnProceed()
    {
        foreach (var seat in selectedSeats)
        {
            Console.WriteLine($"Selected seat: {seat}");
        }
    }
    
    private string GetSeatBackgroundColor(int seatId)
    {
        var seat = _allSeats.FirstOrDefault(s => s.Id == seatId);
        if (seat != null)
        {
            // Check if the seat is reserved or selected
            if (_reservedSeat.Any(r => r.Id == seatId))
            {
                return "red"; // Occupied
            }
            else if (selectedSeats.Contains(seatId))
            {
                return "yellow"; // Selected
            }
        }
        return "green"; // Free
    }
    
    private void SelectSeat(int seatId)
    {
        var isSeatReserved = _reservedSeat.Any(r => r.Id == seatId);
        
        if (!isSeatReserved)
        {
            if (selectedSeats.Contains(seatId))
            {
                selectedSeats.Remove(seatId); // Deselect the seat
            }
            else
            {
                selectedSeats.Add(seatId); // Select the seat
            }
        }
    }

    
}